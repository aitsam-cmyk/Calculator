
const HISTORY_KEY = 'calc_history_v1';
let history = [];
try { const saved = JSON.parse(localStorage.getItem(HISTORY_KEY)); if (Array.isArray(saved)) history = saved; } catch (e) {}
const saveHistory=()=>localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
const addHistory=(r)=>{history.push(r);saveHistory();renderHistory();}
function renderHistory(){const list=document.querySelector('#history-list');if(!history.length){list.textContent='No history available.';return;}list.textContent=history.join('\n');}
const tabButtons=document.querySelectorAll('.tab-btn');const sections=document.querySelectorAll('.section');tabButtons.forEach(b=>b.addEventListener('click',()=>{tabButtons.forEach(x=>x.classList.remove('active'));sections.forEach(s=>s.classList.remove('active'));b.classList.add('active');document.querySelector(b.dataset.target).classList.add('active');}));
const fmt=(x)=>Number.isFinite(x)?Number(x.toFixed(2)):x;function parseInputs(c){return Array.from(c.querySelectorAll('input')).map(i=>parseFloat(i.value)).filter(v=>!Number.isNaN(v));}
function makeExpression(nums,sep){return nums.map(n=>fmt(n)).join(` ${sep} `);}function ensureFields(rowEl,count=2){const existing=rowEl.querySelectorAll('input').length;for(let i=existing;i<count;i++){const inp=document.createElement('input');inp.type='number';inp.step='0.01';inp.className='num';inp.placeholder=`Number ${i+1}`;rowEl.appendChild(inp);}}
function setupMultiOps(){document.querySelectorAll('.inputs.multi').forEach(box=>{const row=box.querySelector('.row');ensureFields(row,2);const addBtn=box.querySelector('.add-field');const removeBtn=box.querySelector('.remove-field');const computeBtn=box.querySelector('.compute');const resultEl=box.parentElement.querySelector('.result');const op=box.dataset.op;addBtn.addEventListener('click',()=>ensureFields(row,row.querySelectorAll('input').length+1));removeBtn.addEventListener('click',()=>{const inputs=row.querySelectorAll('input');if(inputs.length>1)inputs[inputs.length-1].remove();});computeBtn.addEventListener('click',()=>{const nums=parseInputs(row);if(nums.length<1){resultEl.textContent='Enter at least one number.';return;}let record='';let ans;switch(op){case 'add':ans=nums.reduce((a,b)=>a+b,0);record=`Addition: ${makeExpression(nums,'+')} = ${fmt(ans)}`;break;case 'sub':ans=nums.slice(1).reduce((a,b)=>a-b,nums[0]);record=`Subtraction: ${fmt(nums[0])}`+(nums.slice(1).map(n=>` - ${fmt(n)}`).join(''))+` = ${fmt(ans)}`;break;case 'mul':ans=nums.reduce((a,b)=>a*b,1);record=`Multiplication: ${makeExpression(nums,'*')} = ${fmt(ans)}`;break;case 'div':if(nums.slice(1).some(n=>n===0)){resultEl.textContent='Error: Division by zero!';addHistory('Division by zero error');return;}ans=nums.slice(1).reduce((a,b)=>a/b,nums[0]);record=`Division: ${fmt(nums[0])}`+(nums.slice(1).map(n=>` / ${fmt(n)}`).join(''))+` = ${fmt(ans)}`;break;case 'avg':const sum=nums.reduce((a,b)=>a+b,0);ans=sum/nums.length;record=`Average: ${makeExpression(nums,'+')} / ${nums.length} = ${fmt(ans)}`;break;default:return;}resultEl.textContent=record;addHistory(record);});});}
function setupPercentage(){const card=document.querySelector('#basic .card:nth-of-type(6)');const obt=card.querySelector('.obt');const tot=card.querySelector('.tot');const btn=card.querySelector('.compute-percent');const res=card.querySelector('.result');btn.addEventListener('click',()=>{const o=parseFloat(obt.value);const t=parseFloat(tot.value);if(Number.isNaN(o)||Number.isNaN(t)||t===0){res.textContent='Please enter valid numbers (total must be > 0).';return;}const percent=(o/t)*100;const record=`Percentage: ${fmt(o)}/${fmt(t)} = ${percent.toFixed(2)}%`;res.textContent=`Obtained: ${fmt(o)} | Total: ${fmt(t)} | Percentage: ${percent.toFixed(2)}%`;addHistory(record);});}
function setupPow(){const squareCard=document.querySelector('#basic .card:nth-of-type(7)');const cubeCard=document.querySelector('#basic .card:nth-of-type(8)');const sqInp=squareCard.querySelector('.sq-input');const sqBtn=squareCard.querySelector('.compute-square');const sqRes=squareCard.querySelector('.result');sqBtn.addEventListener('click',()=>{const n=parseFloat(sqInp.value);if(Number.isNaN(n)){sqRes.textContent='Enter a valid number.';return;}const ans=n*n;const record=`Square: ${fmt(n)}^2 = ${fmt(ans)}`;sqRes.textContent=record;addHistory(record);});const cuInp=cubeCard.querySelector('.cu-input');const cuBtn=cubeCard.querySelector('.compute-cube');const cuRes=cubeCard.querySelector('.result');cuBtn.addEventListener('click',()=>{const n=parseFloat(cuInp.value);if(Number.isNaN(n)){cuRes.textContent='Enter a valid number.';return;}const ans=n*n*n;const record=`Cube: ${fmt(n)}^3 = ${fmt(ans)}`;cuRes.textContent=record;addHistory(record);});}
function convertPercentageToGPA(percent){if(percent>=85&&percent<=100)return{grade:'A',gradePoint:4.00};else if(percent>=80&&percent<85)return{grade:'A-',gradePoint:3.70};else if(percent>=75&&percent<80)return{grade:'B+',gradePoint:3.30};else if(percent>=70&&percent<75)return{grade:'B',gradePoint:3.00};else if(percent>=65&&percent<70)return{grade:'B-',gradePoint:2.70};else if(percent>=61&&percent<65)return{grade:'C+',gradePoint:2.30};else if(percent>=58&&percent<61)return{grade:'C',gradePoint:2.00};else if(percent>=55&&percent<58)return{grade:'C-',gradePoint:1.70};else if(percent>=50&&percent<55)return{grade:'D',gradePoint:1.00};else return{grade:'F',gradePoint:0.00};}
function convertGPAtoGrade(gpa){if(gpa>=4.00)return{grade:'A',gradePoint:gpa};else if(gpa>=3.70)return{grade:'A-',gradePoint:gpa};else if(gpa>=3.30)return{grade:'B+',gradePoint:gpa};else if(gpa>=3.00)return{grade:'B',gradePoint:gpa};else if(gpa>=2.70)return{grade:'B-',gradePoint:gpa};else if(gpa>=2.30)return{grade:'C+',gradePoint:gpa};else if(gpa>=2.00)return{grade:'C',gradePoint:gpa};else if(gpa>=1.70)return{grade:'C-',gradePoint:gpa};else if(gpa>=1.00)return{grade:'D',gradePoint:gpa};else return{grade:'F',gradePoint:gpa};}
function setupGPA(){const pctCard=document.querySelector('#gpa .grid .card:nth-of-type(1)');const pctInp=pctCard.querySelector('.pct-to-gpa');const pctBtn=pctCard.querySelector('.compute-pct-gpa');const pctRes=pctCard.querySelector('.result');pctBtn.addEventListener('click',()=>{const p=parseFloat(pctInp.value);if(Number.isNaN(p)||p<0||p>100){pctRes.textContent='Enter a valid percentage (0â€“100).';return;}const r=convertPercentageToGPA(p);pctRes.textContent=`Percentage: ${p.toFixed(2)}%\nGrade: ${r.grade}\nG.Point: ${r.gradePoint.toFixed(2)}`;});const tableBody=document.getElementById('subjects-body');const addRowBtn=document.getElementById('add-row');const computeGpaBtn=document.getElementById('compute-gpa');const reportPre=document.querySelector('#gpa .report .result');const printBtn=document.getElementById('print-report');function addRow(){const tr=document.createElement('tr');tr.innerHTML=`<td><input type="text" placeholder="Subject"></td><td><input type=\"number\" step=\"0.01\" placeholder=\"Obtained\"></td><td><input type=\"number\" step=\"0.01\" placeholder=\"Total\"></td><td><input type=\"number\" step=\"0.1\" placeholder=\"Credit Hours\"></td><td><button class=\"del\">Delete</button></td>`;tr.querySelector('.del').addEventListener('click',()=>tr.remove());tableBody.appendChild(tr);}for(let i=0;i<3;i++)addRow();addRowBtn.addEventListener('click',addRow);computeGpaBtn.addEventListener('click',()=>{const rows=Array.from(tableBody.querySelectorAll('tr'));if(!rows.length){reportPre.textContent='Add at least one subject row.';return;}const subjects=[];let totalQuality=0,totalCredits=0,totalObt=0,totalAll=0;for(const tr of rows){const [sInp,obtInp,totInp,crInp]=tr.querySelectorAll('input');const name=sInp.value.trim()||'Subject';const obt=parseFloat(obtInp.value);const tot=parseFloat(totInp.value);const cr=parseFloat(crInp.value);if(Number.isNaN(obt)||Number.isNaN(tot)||tot<=0||Number.isNaN(cr)||cr<=0){reportPre.textContent='Please fill valid numbers for all rows (Total>0, Credit>0).';return;}const pct=(obt/tot)*100;const g=convertPercentageToGPA(pct);subjects.push({name,obt,tot,pct,grade:g.grade,gp:g.gradePoint,cr});totalObt+=obt;totalAll+=tot;totalQuality+=g.gradePoint*cr;totalCredits+=cr;}const gpa=totalQuality/totalCredits;const overall=convertGPAtoGrade(gpa);const pctOverall=(totalObt/totalAll)*100;let report='';report+='\n============================================================================\n';report+=padCols(['Subject','Marks (Obt/Total)','Percentage','Grade','G.Point','CreditHr'])+'\n';report+='-----------------------------------------------------------------------------\n';for(const s of subjects){report+=padCols([s.name,`${fmt(s.obt)}/${fmt(s.tot)}`,s.pct.toFixed(2),s.grade,s.gp.toFixed(2),s.cr.toFixed(1)])+'\n';}report+='---------------------------------------------------------------------------\n';report+=padCols(['TOTAL',`${fmt(totalObt)}/${fmt(totalAll)}`,pctOverall.toFixed(2),overall.grade,gpa.toFixed(2),totalCredits.toFixed(1)])+'\n';report+='============================================================================\n';report+=`ðŸŽ“ CGPA: ${gpa.toFixed(2)} | Overall Grade: ${overall.grade}`;reportPre.textContent=report;addHistory(report);});printBtn.addEventListener('click',()=>{const w=window.open('','_blank');const content=reportPre.textContent.replace(/\n/g,'<br>');w.document.write(`<pre style=\"font-family:monospace\">${content}</pre>`);w.document.close();w.print();});}
function padCols(cols){const widths=[15,18,12,8,10,10];return cols.map((c,i)=>String(c).padEnd(widths[i],' ')).join(' ');}function setupHistoryControls(){renderHistory();const exportBtn=document.getElementById('export-history');const clearBtn=document.getElementById('clear-history');exportBtn.addEventListener('click',()=>{const blob=new Blob([history.join('\n')],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='calculation_history.txt';a.click();URL.revokeObjectURL(url);});clearBtn.addEventListener('click',()=>{if(!history.length)return;const ok=confirm('Clear all history?');if(ok){history=[];saveHistory();renderHistory();}});}setupMultiOps();setupPercentage();setupPow();setupGPA();setupHistoryControls();
